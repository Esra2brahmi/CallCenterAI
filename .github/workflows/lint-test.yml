# .github/workflows/lint-test.yml
name: "Reusable: Lint & Test"

on:
  workflow_call:
    inputs:
      service-path:
        required: true
        type: string
      service-name:
        required: true
        type: string
      needs-real-model:
        required: false
        type: boolean
        default: false

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - mode: fast
            marker: "not integration"
          - mode: integration
            marker: "integration"

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          # This always finds the file – works with any service-path
          key: pip-${{ inputs.service-name }}-${{ hashFiles(format('{0}/requirements.txt', inputs.service-path)) || 'no-reqs' }}
          restore-keys: |
            pip-${{ inputs.service-name }}-

      - name: Install dependencies
        working-directory: ${{ inputs.service-path }}
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install -r ../../requirements/dev.txt
          pip install pytest pytest-cov httpx

      - name: Train TF-IDF model (only for tfidf + integration tests)
        if: inputs.service-name == 'tfidf' && matrix.mode == 'integration'
        working-directory: .
        run: python scripts/train_tfidf.py

      - name: Train Transformer model setup (optional – mock if needed)
        if: inputs.service-name == 'transformer' && matrix.mode == 'integration'
        run: echo "Transformer model would be loaded from MLflow or local path"

      - name: Run tests
        working-directory: ${{ inputs.service-path }}
        env:
          PYTEST_ADDOPTS: -m "${{ matrix.marker }}"
        run: |
          pytest ../../tests \
            --cov=. \
            --cov-report=xml:coverage.xml \
            --junitxml=junit-${{ inputs.service-name }}-${{ matrix.mode }}.xml \
            -vv

      - name: Upload coverage
        if: matrix.mode == 'fast'
        uses: codecov/codecov-action@v4
        with:
          file: ${{ inputs.service-path }}/coverage.xml
          flags: ${{ inputs.service-name }}

      - name: Upload JUnit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-${{ inputs.service-name }}-${{ matrix.mode }}
          path: ${{ inputs.service-path }}/junit-*.xml