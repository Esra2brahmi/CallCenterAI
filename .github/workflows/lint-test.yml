# .github/workflows/lint-test.yml
name: "Reusable: Lint & Test"

on:
  workflow_call:
    inputs:
      service-path:
        required: true
        type: string
      service-name:
        required: true
        type: string
      needs-real-model:
        required: false
        type: boolean
        default: false

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        mode: [fast, integration]
        include:
          - mode: fast
            marker: "not integration"
          - mode: integration
            marker: "integration"

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Reliable cache key – no "+" inside hashFiles()
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ inputs.service-name }}-${{ hashFiles(format('{0}/requirements.txt', inputs.service-path), 'requirements/dev.txt') }}
          restore-keys: |
            pip-${{ inputs.service-name }}-

      - name: Install dependencies
        working-directory: ${{ inputs.service-path }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r ../../requirements/dev.txt
          pip install pytest pytest-cov httpx

      - name: Train TF-IDF model (integration only)
        if: inputs.service-name == 'tfidf' && matrix.mode == 'integration'
        working-directory: .
        run: python scripts/train_tfidf.py   # or add --quick if you prefer

      - name: Run tests – ${{ matrix.mode }}
        working-directory: ${{ inputs.service-path }}
        env:
          PYTEST_ADDOPTS: -m "${{ matrix.marker }}"
        run: |
          pytest ../../tests \
            --cov=. \
            --cov-report=xml:coverage.xml \
            --junitxml=junit-${{ inputs.service-name }}-${{ matrix.mode }}.xml \
            -vv

      - name: Upload coverage to Codecov
        if: matrix.mode == 'fast'
        uses: codecov/codecov-action@v4
        with:
          file: ${{ inputs.service-path }}/coverage.xml
          flags: ${{ inputs.service-name }}

      - name: Upload JUnit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-${{ inputs.service-name }}-${{ matrix.mode }}
          path: ${{ inputs.service-path }}/junit-${{ inputs.service-name }}-${{ matrix.mode }}.xml